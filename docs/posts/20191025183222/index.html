<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.65.2" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Clericpy" />
  <meta property="og:url" content="https://clericpy.github.io/blog/posts/20191025183222/" />
  <link rel="canonical" href="https://clericpy.github.io/blog/posts/20191025183222/" /><link rel="shortcut icon" href="/blog/favicon.ico" type="image/x-png" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/clericpy.github.io\/blog\/"
      },
      "articleSection" : "posts",
      "name" : "爬虫常用代码片段合集 - [torequests.utils]",
      "headline" : "爬虫常用代码片段合集 - [torequests.utils]",
      "description" : "Spider needs HTTP, more than HTTP.",
      "inLanguage" : "en-US",
      "author" : "Clericpy",
      "creator" : "Clericpy",
      "publisher": "Clericpy",
      "accountablePerson" : "Clericpy",
      "copyrightHolder" : "Clericpy",
      "copyrightYear" : "2019",
      "datePublished": "2019-10-25 18:32:22 \x2b0800 CST",
      "dateModified" : "2019-10-25 18:32:22 \x2b0800 CST",
      "url" : "https:\/\/clericpy.github.io\/blog\/posts\/20191025183222\/",
      "keywords" : [  ]
  }
</script>
<title>爬虫常用代码片段合集 - [torequests.utils] - Clericpy&#39;s Blog</title>
  <meta property="og:title" content="爬虫常用代码片段合集 - [torequests.utils] - Clericpy&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta name="description" content="Spider needs HTTP, more than HTTP." />

  <link rel="stylesheet" href="https://cdn.staticfile.org/flexboxgrid/6.3.1/flexboxgrid.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css" />
  <link rel="stylesheet" href="/blog/css/index.css">
  <link href="/blog/index.xml" rel="alternate" type="application/rss+xml" title="Clericpy&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  <script>
    

    (function (undefined) { }).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-150991415-1"></script><script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag("js", new Date());  gtag("config", "UA-150991415-1");</script>
</head>


<body>
    <article class="post Chinese" id="article">
        <div class="row">
            <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
                <div class="site-header">
                    
<header>
  <div class="signatures site-title">
    <a href="/blog/">Clericpy&#39;s Blog</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

                </div>
                <header class="post-header">
                    <h1 class="post-title">爬虫常用代码片段合集 - [torequests.utils]</h1>
                    
                    <div class="row post-desc">
                        <div class="col-xs-2">
                            
                            <time class="post-date" datetime="2019-10-25 18:32:22 CST">
                                25 Oct 2019
                            </time>
                            
                        </div>
                        <div class="col-xs-4">
                            <a href="/blog/categories/python"><b
                                    style="text-decoration:underline">Python</b></a>
                        </div>
                        <div class="col-xs-6">
                            
                            <div class="post-author">
                                <a target="_blank" href="https://github.com/ClericPy">@Clericpy</a>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div id="toc" class="well col-md-12 col-sm-10" style="font-size: 0.8em; border: 1px dashed rgb(194, 194, 194); margin: 15px; padding: 15px;">
                        <h3>Table of Contents</h3>
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#正文">正文</a></li>
  </ul>

  <ul>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
                    </div>
                </header>
                <div class="post-content markdown-body">
                    <hr>
<h2 id="前言">前言</h2>
<p><del>此处省略 150 字引言, 假装以后会补.</del></p>
<h2 id="正文">正文</h2>
<p>以下功能均已收入 <a href="https://github.com/ClericPy/torequests">torequests</a></p>
<blockquote>
<p><em>pip install torequests -U</em></p>
</blockquote>
<ol>
<li>
<p>查看当前进程的内存占用. 借助 <strong>psutil</strong></p>
<ol>
<li>
<p>代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_mem</span>(unit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;MB&#34;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Show the proc-mem-cost with psutil, use this only for lazinesssss.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    :param unit: B, KB, MB, GB.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">try</span>:
        <span style="color:#f92672">import</span> psutil<span style="color:#f92672">,</span> os
      
        B <span style="color:#f92672">=</span> float(psutil<span style="color:#f92672">.</span>Process(os<span style="color:#f92672">.</span>getpid())<span style="color:#f92672">.</span>memory_info()<span style="color:#f92672">.</span>vms)
        KB <span style="color:#f92672">=</span> B <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>
        MB <span style="color:#f92672">=</span> KB <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>
        GB <span style="color:#f92672">=</span> MB <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>
        result <span style="color:#f92672">=</span> vars()[unit]
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;memory usage: </span><span style="color:#e6db74">%.2f</span><span style="color:#e6db74">(</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (result, unit))
        <span style="color:#66d9ef">return</span> result
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;pip install psutil first.&#34;</span>)
      
      
print_mem()  <span style="color:#75715e"># memory usage: 8.93(MB)</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>将 cURL 命令转为人类可读的 dict 参数, 兼容 requests.request</p>
<ol>
<li>
<p>使用原始请求的好处</p>
<ol>
<li>不会因为遗漏请求参数而导致请求失败, 比如 Referer, User-Agent, Accept 等</li>
<li>解析结果可以直接使用 requests.request(**result) 来发出请求</li>
</ol>
</li>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> shlex
<span style="color:#f92672">import</span> argparse
      
      
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_Curl</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;Curl args parser.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    **Use curlparse function directly.**
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
      
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;curl&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;url&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-X&#34;</span>, <span style="color:#e6db74">&#34;--method&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;get&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-A&#34;</span>, <span style="color:#e6db74">&#34;--user-agent&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-u&#34;</span>, <span style="color:#e6db74">&#34;--user&#34;</span>)  <span style="color:#75715e"># &lt;user[:password]&gt;</span>
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-x&#34;</span>, <span style="color:#e6db74">&#34;--proxy&#34;</span>)  <span style="color:#75715e"># proxy.com:port</span>
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-d&#34;</span>, <span style="color:#e6db74">&#34;--data&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-F&#34;</span>, <span style="color:#e6db74">&#34;--form&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--data-binary&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--connect-timeout&#34;</span>, type<span style="color:#f92672">=</span>float)
    parser<span style="color:#f92672">.</span>add_argument(
        <span style="color:#e6db74">&#34;-H&#34;</span>, <span style="color:#e6db74">&#34;--header&#34;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;append&#34;</span>, default<span style="color:#f92672">=</span>[])  <span style="color:#75715e"># key: value</span>
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--compressed&#34;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store_true&#34;</span>)
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">curlparse</span>(string, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Translate curl-string into dict of request.
</span><span style="color:#e6db74">        :param string: standard curl-string, like `r&#39;&#39;&#39;curl ...&#39;&#39;&#39;`.
</span><span style="color:#e6db74">        :param encoding: encoding for post-data encoding.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    Basic Usage::
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">      &gt;&gt;&gt; from torequests.utils import curlparse
</span><span style="color:#e6db74">      &gt;&gt;&gt; curl_string = &#39;&#39;&#39;curl &#39;https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Pragma: no-cache&#39; -H &#39;DNT: 1&#39; -H &#39;Accept-Encoding: gzip, deflate&#39; -H &#39;Accept-Language: zh-CN,zh;q=0.9&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; -H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&#39; -H &#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#39; -H &#39;Cache-Control: no-cache&#39; -H &#39;Referer: https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Cookie: ASPSESSIONIDSQRRSADB=MLHDPOPCAMBDGPFGBEEJKLAF&#39; -H &#39;Connection: keep-alive&#39; --compressed&#39;&#39;&#39;
</span><span style="color:#e6db74">      &gt;&gt;&gt; request_args = curlparse(curl_string)
</span><span style="color:#e6db74">      &gt;&gt;&gt; request_args
</span><span style="color:#e6db74">      {&#39;url&#39;: &#39;https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39;, &#39;headers&#39;: {&#39;Pragma&#39;: &#39;no-cache&#39;, &#39;Dnt&#39;: &#39;1&#39;, &#39;Accept-Encoding&#39;: &#39;gzip, deflate&#39;, &#39;Accept-Language&#39;: &#39;zh-CN,zh;q=0.9&#39;, &#39;Upgrade-Insecure-Requests&#39;: &#39;1&#39;, &#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&#39;, &#39;Accept&#39;: &#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#39;, &#39;Cache-Control&#39;: &#39;no-cache&#39;, &#39;Referer&#39;: &#39;https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39;, &#39;Cookie&#39;: &#39;ASPSESSIONIDSQRRSADB=MLHDPOPCAMBDGPFGBEEJKLAF&#39;, &#39;Connection&#39;: &#39;keep-alive&#39;}, &#39;method&#39;: &#39;get&#39;}
</span><span style="color:#e6db74">      &gt;&gt;&gt; import requests
</span><span style="color:#e6db74">      &gt;&gt;&gt; requests.request(**request_args)
</span><span style="color:#e6db74">      &lt;Response [200]&gt;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> string, <span style="color:#e6db74">&#39;curl-string should not contain </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n, try r&#34;...&#34;.&#39;</span>
    <span style="color:#66d9ef">if</span> string<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;http&#34;</span>):
        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;url&#34;</span>: string, <span style="color:#e6db74">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;get&#34;</span>}
    <span style="color:#66d9ef">try</span>:
        lex_list <span style="color:#f92672">=</span> shlex<span style="color:#f92672">.</span>split(string<span style="color:#f92672">.</span>strip())
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">if</span> str(e) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;No closing quotation&#39;</span> <span style="color:#f92672">and</span> string<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#34;&#39;&#34;</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            print_info(
                <span style="color:#e6db74">&#34;If `data` has single-quote (&#39;), the `data` should be quote by double-quote, and add the `backslash`(</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">) before original </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.&#34;</span>
            )
        <span style="color:#66d9ef">raise</span> e
    args, unknown <span style="color:#f92672">=</span> _Curl<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse_known_args(lex_list)
    requests_args <span style="color:#f92672">=</span> {}
    headers <span style="color:#f92672">=</span> {}
    requests_args[<span style="color:#e6db74">&#34;url&#34;</span>] <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>url
    <span style="color:#66d9ef">for</span> header <span style="color:#f92672">in</span> args<span style="color:#f92672">.</span>header:
        key, value <span style="color:#f92672">=</span> header<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#ae81ff">1</span>)
        headers[key<span style="color:#f92672">.</span>title()] <span style="color:#f92672">=</span> value<span style="color:#f92672">.</span>strip()
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>user_agent:
        headers[<span style="color:#e6db74">&#34;User-Agent&#34;</span>] <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>user_agent
    <span style="color:#66d9ef">if</span> headers:
        requests_args[<span style="color:#e6db74">&#34;headers&#34;</span>] <span style="color:#f92672">=</span> headers
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>user:
        requests_args[<span style="color:#e6db74">&#34;auth&#34;</span>] <span style="color:#f92672">=</span> tuple(
            u <span style="color:#66d9ef">for</span> u <span style="color:#f92672">in</span> args<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#34;&#34;</span>])[:<span style="color:#ae81ff">2</span>]
    <span style="color:#75715e"># if args.proxy:</span>
    <span style="color:#75715e"># pass</span>
    data <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>data <span style="color:#f92672">or</span> args<span style="color:#f92672">.</span>data_binary <span style="color:#f92672">or</span> args<span style="color:#f92672">.</span>form
    <span style="color:#66d9ef">if</span> data:
        <span style="color:#66d9ef">if</span> data<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;$&#34;</span>):
            data <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">1</span>:]
        args<span style="color:#f92672">.</span>method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;post&#34;</span>
        <span style="color:#66d9ef">if</span> PY2:
            <span style="color:#75715e"># TODO not fix the UnicodeEncodeError, so use `replace`, damn python2.x.</span>
            data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\r&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\n&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>encode(
                <span style="color:#e6db74">&#39;latin-1&#39;</span>,
                <span style="color:#e6db74">&#39;backslashreplace&#39;</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;unicode-escape&#39;</span>)<span style="color:#f92672">.</span>encode(encoding)
        requests_args[<span style="color:#e6db74">&#34;data&#34;</span>] <span style="color:#f92672">=</span> data
    requests_args[<span style="color:#e6db74">&#34;method&#34;</span>] <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>method<span style="color:#f92672">.</span>lower()
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>connect_timeout:
        requests_args[<span style="color:#e6db74">&#34;timeout&#34;</span>] <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>connect_timeout
    <span style="color:#66d9ef">return</span> requests_args
      
      
<span style="color:#66d9ef">print</span>(
    curlparse(
        <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;&#39;curl &#39;https://httpbin.org/get&#39; -H &#39;Connection: keep-alive&#39; -H &#39;Cache-Control: max-age=0&#39; -H &#39;DNT: 1&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; -H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.70 Safari/537.36&#39; -H &#39;Sec-Fetch-User: ?1&#39; -H &#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&#39; -H &#39;Sec-Fetch-Site: none&#39; -H &#39;Sec-Fetch-Mode: navigate&#39; -H &#39;Accept-Encoding: gzip, deflate, br&#39; -H &#39;Accept-Language: zh-CN,zh;q=0.9&#39; --compressed&#39;&#39;&#39;</span>
    ))
<span style="color:#75715e"># {&#39;url&#39;: &#39;https://httpbin.org/get&#39;, &#39;headers&#39;: {&#39;Connection&#39;: &#39;keep-alive&#39;, &#39;Cache-Control&#39;: &#39;max-age=0&#39;, &#39;Dnt&#39;: &#39;1&#39;, &#39;Upgrade-Insecure-Requests&#39;: &#39;1&#39;, &#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.70 Safari/537.36&#39;, &#39;Sec-Fetch-User&#39;: &#39;?1&#39;, &#39;Accept&#39;: &#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&#39;, &#39;Sec-Fetch-Site&#39;: &#39;none&#39;, &#39;Sec-Fetch-Mode&#39;: &#39;navigate&#39;, &#39;Accept-Encoding&#39;: &#39;gzip, deflate, br&#39;, &#39;Accept-Language&#39;: &#39;zh-CN,zh;q=0.9&#39;}, &#39;method&#39;: &#39;get&#39;}</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>将多个可迭代对象合并成一个生成器</p>
<ol>
<li>
<p>Python3 中已经默认实现</p>
<ol>
<li>
<blockquote>
<p>from itertools import chain</p>
</blockquote>
</li>
</ol>
</li>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">itertools_chain</span>(<span style="color:#f92672">*</span>iterables):
    <span style="color:#e6db74">&#34;&#34;&#34;For the shortage of Python2&#39;s, Python3: `from itertools import chain`.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> iterables:
        <span style="color:#66d9ef">for</span> element <span style="color:#f92672">in</span> it:
            <span style="color:#66d9ef">yield</span> element
</code></pre></div></li>
</ol>
</li>
<li>
<p>将一个序列均分成 n 等份 &amp; 将一个序列按照长度 n 等分</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> chain <span style="color:#66d9ef">as</span> itertools_chain
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slice_by_size</span>(seq, size):
    <span style="color:#e6db74">&#34;&#34;&#34;Slice a sequence into chunks, return as a generation of chunks with `size`.  &#34;&#34;&#34;</span>
    filling <span style="color:#f92672">=</span> object()
    <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> zip(<span style="color:#f92672">*</span>(itertools_chain(seq, [filling] <span style="color:#f92672">*</span> size),) <span style="color:#f92672">*</span> size):
        <span style="color:#66d9ef">if</span> filling <span style="color:#f92672">in</span> it:
            it <span style="color:#f92672">=</span> tuple(i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> it <span style="color:#66d9ef">if</span> i <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> filling)
        <span style="color:#66d9ef">if</span> it:
            <span style="color:#66d9ef">yield</span> it
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slice_into_pieces</span>(seq, n):
    <span style="color:#e6db74">&#34;&#34;&#34;Slice a sequence into `n` pieces, return a generation of n pieces&#34;&#34;&#34;</span>
    length <span style="color:#f92672">=</span> len(seq)
    <span style="color:#66d9ef">if</span> length <span style="color:#f92672">%</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        size <span style="color:#f92672">=</span> length <span style="color:#f92672">//</span> n
    <span style="color:#66d9ef">else</span>:
        size <span style="color:#f92672">=</span> length <span style="color:#f92672">//</span> n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">for</span> it <span style="color:#f92672">in</span> slice_by_size(seq, size):
        <span style="color:#66d9ef">yield</span> it
      
      
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
items <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">10</span>))
chunks <span style="color:#f92672">=</span> slice_by_size(items, n)
<span style="color:#66d9ef">print</span>(list(chunks))
<span style="color:#75715e"># [(0, 1, 2), (3, 4, 5), (6, 7, 8), (9,)]</span>
chunks <span style="color:#f92672">=</span> slice_into_pieces(items, n)
<span style="color:#66d9ef">print</span>(list(chunks))
<span style="color:#75715e"># [(0, 1, 2, 3), (4, 5, 6, 7), (8, 9)]</span>
<span style="color:#75715e"># ==================================</span>
<span style="color:#75715e"># 不在乎性能, slice_by_size 也可以使用如下简单的写法</span>
chunks <span style="color:#f92672">=</span> (items[i:i <span style="color:#f92672">+</span> n] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(items), n))
<span style="color:#66d9ef">print</span>(list(chunks))
<span style="color:#75715e"># [[0, 1, 2], [3, 4, 5], [6, 7, 8], [9]]</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>简单地根据时区处理 时间戳 ↔ 当地时间</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
      
TIMEZONE <span style="color:#f92672">=</span> int(<span style="color:#f92672">-</span>time<span style="color:#f92672">.</span>timezone <span style="color:#f92672">/</span> <span style="color:#ae81ff">3600</span>)
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ttime</span>(timestamp<span style="color:#f92672">=</span>None, tzone<span style="color:#f92672">=</span>None, fail<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, fmt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Translate timestamp into human-readable: %Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    :param timestamp: the timestamp float, or `time.time()` by default.
</span><span style="color:#e6db74">    :param tzone: time compensation, int(-time.timezone / 3600) by default,
</span><span style="color:#e6db74">                (can be set with TIMEZONE).
</span><span style="color:#e6db74">    :param fail: while raising an exception, return it.
</span><span style="color:#e6db74">    :param fmt: %Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S, %z not work.
</span><span style="color:#e6db74">    :rtype: str
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; ttime()
</span><span style="color:#e6db74">    2018-03-15 01:24:35
</span><span style="color:#e6db74">    &gt;&gt;&gt; ttime(1486572818.421858323)
</span><span style="color:#e6db74">    2017-02-09 00:53:38
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    tzone <span style="color:#f92672">=</span> TIMEZONE <span style="color:#66d9ef">if</span> tzone <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> tzone
    fix_tz <span style="color:#f92672">=</span> tzone <span style="color:#f92672">*</span> <span style="color:#ae81ff">3600</span>
    <span style="color:#66d9ef">if</span> timestamp <span style="color:#f92672">is</span> None:
        timestamp <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    <span style="color:#66d9ef">else</span>:
        timestamp <span style="color:#f92672">=</span> float(timestamp)
        <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">1e12</span> <span style="color:#f92672">&lt;=</span> timestamp <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1e13</span>:
            <span style="color:#75715e"># Compatible timestamp with 13-digit milliseconds</span>
            timestamp <span style="color:#f92672">=</span> timestamp <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>
    <span style="color:#66d9ef">try</span>:
        timestamp <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#66d9ef">if</span> timestamp <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> timestamp
        <span style="color:#66d9ef">return</span> time<span style="color:#f92672">.</span>strftime(fmt, time<span style="color:#f92672">.</span>gmtime(timestamp <span style="color:#f92672">+</span> fix_tz))
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> fail
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ptime</span>(timestr<span style="color:#f92672">=</span>None, tzone<span style="color:#f92672">=</span>None, fail<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, fmt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Translate %Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S into timestamp.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    :param timestr: string like 2018-03-15 01:27:56, or time.time() if not set.
</span><span style="color:#e6db74">    :param tzone: time compensation, int(-time.timezone / 3600) by default,
</span><span style="color:#e6db74">                (can be set with TIMEZONE).
</span><span style="color:#e6db74">    :param fail: while raising an exception, return it.
</span><span style="color:#e6db74">    :param fmt: %Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S, %z not work.
</span><span style="color:#e6db74">    :rtype: int
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">        &gt;&gt;&gt; ptime(&#39;2018-03-15 01:27:56&#39;)
</span><span style="color:#e6db74">        1521048476
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    tzone <span style="color:#f92672">=</span> TIMEZONE <span style="color:#66d9ef">if</span> tzone <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> tzone
    fix_tz <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(tzone <span style="color:#f92672">*</span> <span style="color:#ae81ff">3600</span> <span style="color:#f92672">+</span> time<span style="color:#f92672">.</span>timezone)
    <span style="color:#75715e">#: str(timestr) for datetime.datetime object</span>
    timestr <span style="color:#f92672">=</span> str(timestr <span style="color:#f92672">or</span> ttime())
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">return</span> int(time<span style="color:#f92672">.</span>mktime(time<span style="color:#f92672">.</span>strptime(timestr, fmt)) <span style="color:#f92672">+</span> fix_tz)
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> fail
      
      
<span style="color:#75715e"># 当地时间的当前时间</span>
<span style="color:#66d9ef">print</span>(ttime())  <span style="color:#75715e"># 2019-10-25 19:12:59</span>
<span style="color:#75715e"># 0 时区的当前时间</span>
<span style="color:#66d9ef">print</span>(ttime(tzone<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>))  <span style="color:#75715e"># 2019-10-25 11:12:59</span>
<span style="color:#75715e"># 当地时间的当前时间戳</span>
<span style="color:#66d9ef">print</span>(ptime())  <span style="color:#75715e"># 1572001979</span>
<span style="color:#66d9ef">print</span>(ptime(ttime()))  <span style="color:#75715e"># 1572001979</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>将单位秒的数字转化成人类可读的字符串或字典</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_seconds</span>(seconds):
    <span style="color:#e6db74">&#34;&#34;&#34;Split seconds into [day, hour, minute, second, ms]
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">        `divisor: 1, 24, 60, 60, 1000`
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">        `units: day, hour, minute, second, ms`
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; split_seconds(6666666)
</span><span style="color:#e6db74">    [77, 3, 51, 6, 0]
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    ms <span style="color:#f92672">=</span> seconds <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
    divisors <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">1000</span>)
    quotient, result <span style="color:#f92672">=</span> ms, []
    <span style="color:#66d9ef">for</span> divisor <span style="color:#f92672">in</span> divisors[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
        quotient, remainder <span style="color:#f92672">=</span> divmod(quotient, divisor)
        result<span style="color:#f92672">.</span>append(quotient) <span style="color:#66d9ef">if</span> divisor <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> result<span style="color:#f92672">.</span>append(remainder)
    <span style="color:#66d9ef">return</span> result[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">timeago</span>(seconds<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, accuracy<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, format<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, lang<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Translate seconds into human-readable.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">        :param seconds: seconds (float/int).
</span><span style="color:#e6db74">        :param accuracy: 4 by default (units[:accuracy]), determine the length of elements.
</span><span style="color:#e6db74">        :param format: index of [led, literal, dict].
</span><span style="color:#e6db74">        :param lang: en or cn.
</span><span style="color:#e6db74">        :param units: day, hour, minute, second, ms.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; timeago(93245732.0032424, 5)
</span><span style="color:#e6db74">    &#39;1079 days, 05:35:32,003&#39;
</span><span style="color:#e6db74">    &gt;&gt;&gt; timeago(93245732.0032424, 4, 1)
</span><span style="color:#e6db74">    &#39;1079 days 5 hours 35 minutes 32 seconds&#39;
</span><span style="color:#e6db74">    &gt;&gt;&gt; timeago(-389, 4, 1)
</span><span style="color:#e6db74">    &#39;-6 minutes 29 seconds 0 ms&#39;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">assert</span> format <span style="color:#f92672">in</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>,
                      <span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;format arg should be one of 0, 1, 2&#34;</span>)
    negative <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#66d9ef">if</span> seconds <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>
    seconds <span style="color:#f92672">=</span> abs(seconds)
    <span style="color:#66d9ef">if</span> lang <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;en&#34;</span>:
        units <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;day&#34;</span>, <span style="color:#e6db74">&#34;hour&#34;</span>, <span style="color:#e6db74">&#34;minute&#34;</span>, <span style="color:#e6db74">&#34;second&#34;</span>, <span style="color:#e6db74">&#34;ms&#34;</span>)
    <span style="color:#66d9ef">elif</span> lang <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cn&#34;</span>:
        units <span style="color:#f92672">=</span> (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;天&#34;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;小时&#34;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;分钟&#34;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;秒&#34;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;毫秒&#34;</span>)
    times <span style="color:#f92672">=</span> split_seconds(seconds)
    <span style="color:#66d9ef">if</span> format <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
        <span style="color:#66d9ef">return</span> dict(zip(units, times))
      
    day, hour, minute, second, ms <span style="color:#f92672">=</span> times
      
    <span style="color:#66d9ef">if</span> format <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        day_str <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s%s</span><span style="color:#e6db74">, &#34;</span> <span style="color:#f92672">%</span> (day, units[<span style="color:#ae81ff">0</span>],
                                  <span style="color:#e6db74">&#34;s&#34;</span> <span style="color:#66d9ef">if</span> day <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> lang <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;en&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>)
                   <span style="color:#66d9ef">if</span> day <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>)
        mid_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">.</span>join((<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%02d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> (hour, minute, second)))
        <span style="color:#66d9ef">if</span> accuracy <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span>:
            mid_str <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,</span><span style="color:#e6db74">%03d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> ms
        <span style="color:#66d9ef">return</span> negative <span style="color:#f92672">+</span> day_str <span style="color:#f92672">+</span> mid_str
    <span style="color:#66d9ef">elif</span> format <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#75715e"># find longest valid fields index (non-zero in front)</span>
        valid_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">for</span> x, i <span style="color:#f92672">in</span> enumerate(times):
            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
                valid_index <span style="color:#f92672">=</span> x
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">else</span>:
            valid_index <span style="color:#f92672">=</span> x
        result_str <span style="color:#f92672">=</span> [
            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (num, unit, <span style="color:#e6db74">&#34;s&#34;</span>
                         <span style="color:#66d9ef">if</span> lang <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;en&#34;</span> <span style="color:#f92672">and</span> num <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> unit <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;ms&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>)
            <span style="color:#66d9ef">for</span> num, unit <span style="color:#f92672">in</span> zip(times, units)
        ][valid_index:][:accuracy]
        result_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join(result_str)
        <span style="color:#66d9ef">return</span> negative <span style="color:#f92672">+</span> result_str
      
      
<span style="color:#66d9ef">print</span>(split_seconds(<span style="color:#ae81ff">6666666.66</span>))
<span style="color:#75715e"># [77.0, 3.0, 51.0, 6.0, 660.0]</span>
<span style="color:#66d9ef">print</span>(timeago(<span style="color:#ae81ff">93245732.0032424</span>, <span style="color:#ae81ff">5</span>))
<span style="color:#75715e"># 1079 days, 05:35:32,003</span>
<span style="color:#66d9ef">print</span>(timeago(<span style="color:#ae81ff">93245732.0032424</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>))
<span style="color:#75715e"># 1079 days 5 hours 35 minutes 32 seconds</span>
<span style="color:#66d9ef">print</span>(timeago(<span style="color:#f92672">-</span><span style="color:#ae81ff">389</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>))
<span style="color:#75715e"># -6 minutes 29 seconds 0 ms</span>
<span style="color:#66d9ef">print</span>(timeago(<span style="color:#f92672">-</span><span style="color:#ae81ff">389</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;cn&#39;</span>))
<span style="color:#75715e"># -6 分钟 29 秒 0 毫秒</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>将一个对象转为字符串, 用 utf-8 编码, 并取其 md5</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hashlib
      
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(range(<span style="color:#ae81ff">1</span>), list):
    <span style="color:#75715e"># python3</span>
    unicode <span style="color:#f92672">=</span> str
      
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">md5</span>(string, n<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>, skip_encode<span style="color:#f92672">=</span>False):
    <span style="color:#e6db74">&#34;&#34;&#34;str(obj) -&gt; md5_string
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    :param string: string to operate.
</span><span style="color:#e6db74">    :param n: md5_str length.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; from torequests.utils import md5
</span><span style="color:#e6db74">    &gt;&gt;&gt; md5(1, 10)
</span><span style="color:#e6db74">    &#39;923820dcc5&#39;
</span><span style="color:#e6db74">    &gt;&gt;&gt; md5(&#39;test&#39;)
</span><span style="color:#e6db74">    &#39;098f6bcd4621d373cade4e832627b4f6&#39;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    todo <span style="color:#f92672">=</span> string <span style="color:#66d9ef">if</span> skip_encode <span style="color:#66d9ef">else</span> unicode(string)<span style="color:#f92672">.</span>encode(encoding)
    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span>:
        <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>md5(todo)<span style="color:#f92672">.</span>hexdigest()
    <span style="color:#66d9ef">elif</span> isinstance(n, (int, float)):
        <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>md5(todo)<span style="color:#f92672">.</span>hexdigest()[(<span style="color:#ae81ff">32</span> <span style="color:#f92672">-</span> n) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>:(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>]
    <span style="color:#66d9ef">elif</span> isinstance(n, (tuple, list)):
        <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>md5(todo)<span style="color:#f92672">.</span>hexdigest()[n[<span style="color:#ae81ff">0</span>]:n[<span style="color:#ae81ff">1</span>]]
      
      
<span style="color:#66d9ef">print</span>(md5(<span style="color:#e6db74">&#39;test&#39;</span>))
<span style="color:#75715e"># 098f6bcd4621d373cade4e832627b4f6</span>
<span style="color:#66d9ef">print</span>(md5([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]))
<span style="color:#75715e"># 49a5a960c5714c2e29dd1a7e7b950741</span>
<span style="color:#66d9ef">print</span>(md5(object))
<span style="color:#75715e"># 6abc48afdb859b639e0a0e1edd225a99</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>一个简简单单的计数器, 实际貌似没什么用&hellip;</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">      
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Counts</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Counter for counting the times been called
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; from torequests.utils import Counts
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc = Counts()
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc.x
</span><span style="color:#e6db74">    1
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc.x
</span><span style="color:#e6db74">    2
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc.now
</span><span style="color:#e6db74">    2
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc.current
</span><span style="color:#e6db74">    2
</span><span style="color:#e6db74">    &gt;&gt;&gt; cc.sub()
</span><span style="color:#e6db74">    1
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
      
    __slots__ <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;start&#34;</span>, <span style="color:#e6db74">&#34;step&#34;</span>, <span style="color:#e6db74">&#34;current&#34;</span>, <span style="color:#e6db74">&#34;total&#34;</span>)
      
    <span style="color:#66d9ef">def</span> __init__(self, start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, step<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
        self<span style="color:#f92672">.</span>start <span style="color:#f92672">=</span> start
        self<span style="color:#f92672">.</span>step <span style="color:#f92672">=</span> step
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">=</span> start
        self<span style="color:#f92672">.</span>total <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
      
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clear</span>(self):
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>start
      
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>add()
      
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">s</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sub()
      
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">c</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>x
      
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">now</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current
      
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, num<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">+=</span> num <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>step
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current
      
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sub</span>(self, num<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">-=</span> num <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>step
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current
</code></pre></div></li>
</ol>
</li>
<li>
<p>给序列去重并返回一个保留原始顺序的生成器.</p>
<ol>
<li>
<p>目前用过的最佳性能还是通过一个 seen set 来判断</p>
</li>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unique</span>(seq, key<span style="color:#f92672">=</span>None, return_as<span style="color:#f92672">=</span>None):
    <span style="color:#e6db74">&#34;&#34;&#34;Unique the seq and keep the order.
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    Instead of the slow way:
</span><span style="color:#e6db74">        `lambda seq: (x for index, x in enumerate(seq) if seq.index(x)==index)`
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    :param seq: raw sequence.
</span><span style="color:#e6db74">    :param return_as: generator for default, or list / set / str...
</span><span style="color:#e6db74">      
</span><span style="color:#e6db74">    &gt;&gt;&gt; from torequests.utils import unique
</span><span style="color:#e6db74">    &gt;&gt;&gt; a = [1,2,3,4,2,3,4]
</span><span style="color:#e6db74">    &gt;&gt;&gt; unique(a)
</span><span style="color:#e6db74">    &lt;generator object unique.&lt;locals&gt;.&lt;genexpr&gt; at 0x05720EA0&gt;
</span><span style="color:#e6db74">    &gt;&gt;&gt; unique(a, str)
</span><span style="color:#e6db74">    &#39;1234&#39;
</span><span style="color:#e6db74">    &gt;&gt;&gt; unique(a, list)
</span><span style="color:#e6db74">    [1, 2, 3, 4]
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    seen <span style="color:#f92672">=</span> set()
    add <span style="color:#f92672">=</span> seen<span style="color:#f92672">.</span>add
    <span style="color:#66d9ef">if</span> key:
        generator <span style="color:#f92672">=</span> (x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> seq <span style="color:#66d9ef">if</span> key(x) <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> seen <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> add(key(x)))
    <span style="color:#66d9ef">else</span>:
        generator <span style="color:#f92672">=</span> (x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> seq <span style="color:#66d9ef">if</span> x <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> seen <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> add(x))
    <span style="color:#66d9ef">if</span> return_as:
        <span style="color:#66d9ef">if</span> return_as <span style="color:#f92672">==</span> str:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(map(str, generator))
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> return_as(generator)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#75715e"># python2 not support yield from</span>
        <span style="color:#66d9ef">return</span> generator
</code></pre></div></li>
</ol>
</li>
<li>
<p>通过正则表达式来注册和查找函数, 实现简易模式匹配</p>
<ol>
<li>
<p>简单地说, 就是通过装饰器来绑定一个函数和一段正则表达式, 之后按照字符串来找到对应函数.</p>
</li>
<li>
<p>常见用途:</p>
<ol>
<li>
<p>用正则表达式注册一个爬虫函数, 方便在遇到符合正则的 URL 时执行对应函数</p>
</li>
<li>
<p>HTTP server 的 route 查询</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Regex</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Register some objects(like functions) to the regular expression.
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">    &gt;&gt;&gt; from torequests.utils import Regex, re
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg = Regex()
</span><span style="color:#e6db74">    &gt;&gt;&gt; @reg.register_function(&#39;http.*cctv.*&#39;)
</span><span style="color:#e6db74">    ... def mock():
</span><span style="color:#e6db74">    ...     pass
</span><span style="color:#e6db74">    ...
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.register(&#39;http.*HELLOWORLD&#39;, &#39;helloworld&#39;, instances=&#39;http://helloworld&#39;, flags=re.I)
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.register(&#39;http.*HELLOWORLD2&#39;, &#39;helloworld2&#39;, flags=re.I)
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.find(&#39;http://cctv.com&#39;)
</span><span style="color:#e6db74">    [&lt;function mock at 0x031FC5D0&gt;]
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.match(&#39;http://helloworld&#39;)
</span><span style="color:#e6db74">    [&#39;helloworld&#39;]
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.match(&#39;non-http://helloworld&#39;)
</span><span style="color:#e6db74">    []
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.search(&#39;non-http://helloworld&#39;)
</span><span style="color:#e6db74">    [&#39;helloworld&#39;]
</span><span style="color:#e6db74">    &gt;&gt;&gt; len(reg.search(&#39;non-http://helloworld2&#39;))
</span><span style="color:#e6db74">    2
</span><span style="color:#e6db74">    &gt;&gt;&gt; print(reg.show_all())
</span><span style="color:#e6db74">    (&#39;http.*cctv.*&#39;) =&gt;  =&gt; &lt;class &#39;function&#39;&gt; mock &#34;&#34;
</span><span style="color:#e6db74">    (&#39;http.*HELLOWORLD&#39;, re.IGNORECASE) =&gt; http://helloworld =&gt; &lt;class &#39;str&#39;&gt; helloworld
</span><span style="color:#e6db74">    (&#39;http.*HELLOWORLD2&#39;, re.IGNORECASE) =&gt;  =&gt; &lt;class &#39;str&#39;&gt; helloworld2
</span><span style="color:#e6db74">    &gt;&gt;&gt; reg.fuzzy(&#39;non-http://helloworld&#39;)
</span><span style="color:#e6db74">    [(&#39;http://helloworld&#39;, 95)]
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
          
    <span style="color:#66d9ef">def</span> __init__(self, ensure_mapping<span style="color:#f92672">=</span>False):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        :param ensure_mapping: ensure mapping one to one, if False,
</span><span style="color:#e6db74">         will return all(more than 1) mapped object list.&#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>container <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>ensure_mapping <span style="color:#f92672">=</span> ensure_mapping
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register</span>(self, patterns, obj<span style="color:#f92672">=</span>None, instances<span style="color:#f92672">=</span>None, <span style="color:#f92672">**</span>reg_kwargs):
        <span style="color:#e6db74">&#34;&#34;&#34;Register one object which can be matched/searched by regex.
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">        :param patterns: a list/tuple/set of regex-pattern.
</span><span style="color:#e6db74">        :param obj: return it while search/match success.
</span><span style="color:#e6db74">        :param instances: instance list will search/match the patterns.
</span><span style="color:#e6db74">        :param reg_kwargs: kwargs for re.compile.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">assert</span> obj, <span style="color:#e6db74">&#34;bool(obj) should be True.&#34;</span>
        patterns <span style="color:#f92672">=</span> patterns <span style="color:#66d9ef">if</span> isinstance(patterns, (list, tuple, set)) <span style="color:#66d9ef">else</span> [patterns]
        instances <span style="color:#f92672">=</span> instances <span style="color:#f92672">or</span> []
        instances <span style="color:#f92672">=</span> (
            instances <span style="color:#66d9ef">if</span> isinstance(instances, (list, tuple, set)) <span style="color:#66d9ef">else</span> [instances]
        )
        <span style="color:#66d9ef">for</span> pattern <span style="color:#f92672">in</span> patterns:
            pattern_compiled <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(pattern, <span style="color:#f92672">**</span>reg_kwargs)
            self<span style="color:#f92672">.</span>container<span style="color:#f92672">.</span>append((pattern_compiled, obj, instances))
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ensure_mapping:
                <span style="color:#75715e"># check all instances to avoid one-to-many instances.</span>
                self<span style="color:#f92672">.</span>_check_instances()
            <span style="color:#66d9ef">else</span>:
                <span style="color:#75715e"># no need to check all instances.</span>
                <span style="color:#66d9ef">for</span> instance <span style="color:#f92672">in</span> instances:
                    <span style="color:#66d9ef">assert</span> self<span style="color:#f92672">.</span>search(instance) <span style="color:#f92672">==</span> [obj] <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>match(instance) <span style="color:#f92672">==</span> [
                        obj
                    ], (
                        <span style="color:#e6db74">&#34;instance </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> should fit at least one pattern </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>
                        <span style="color:#f92672">%</span> (instance, pattern)
                    )
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_function</span>(self, patterns, instances<span style="color:#f92672">=</span>None, <span style="color:#f92672">**</span>reg_kwargs):
        <span style="color:#e6db74">&#34;&#34;&#34;Decorator for register.&#34;&#34;&#34;</span>
          
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(function):
            self<span style="color:#f92672">.</span>register(patterns, function, instances<span style="color:#f92672">=</span>instances, <span style="color:#f92672">**</span>reg_kwargs)
            <span style="color:#66d9ef">return</span> function
          
        <span style="color:#66d9ef">return</span> wrapper
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find</span>(self, string, default<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;Return match or search result.
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">        :rtype: list&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>match(string) <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>search(string) <span style="color:#f92672">or</span> default
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search</span>(self, string, default<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;Use re.search to find the result
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">        :rtype: list&#34;&#34;&#34;</span>
        default <span style="color:#f92672">=</span> default <span style="color:#66d9ef">if</span> default <span style="color:#66d9ef">else</span> []
        result <span style="color:#f92672">=</span> [item[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>container <span style="color:#66d9ef">if</span> item[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>search(string)]
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ensure_mapping:
            <span style="color:#66d9ef">assert</span> len(result) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> matches more than one pattern: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (
                string,
                result,
            )
        <span style="color:#66d9ef">return</span> result <span style="color:#66d9ef">if</span> result <span style="color:#66d9ef">else</span> default
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">match</span>(self, string, default<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;Use re.search to find the result
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">        :rtype: list&#34;&#34;&#34;</span>
        default <span style="color:#f92672">=</span> default <span style="color:#66d9ef">if</span> default <span style="color:#66d9ef">else</span> []
        result <span style="color:#f92672">=</span> [item[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>container <span style="color:#66d9ef">if</span> item[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>match(string)]
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ensure_mapping:
            <span style="color:#66d9ef">assert</span> len(result) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> matches more than one pattern: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (
                string,
                result,
            )
        <span style="color:#66d9ef">return</span> result <span style="color:#66d9ef">if</span> result <span style="color:#66d9ef">else</span> default
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fuzzy</span>(self, key, limit<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>):
        <span style="color:#e6db74">&#34;&#34;&#34;Give suggestion from all instances.&#34;&#34;&#34;</span>
        instances <span style="color:#f92672">=</span> [i[<span style="color:#ae81ff">2</span>] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>container <span style="color:#66d9ef">if</span> i[<span style="color:#ae81ff">2</span>]]
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> instances:
            <span style="color:#66d9ef">return</span>
        instances <span style="color:#f92672">=</span> sum(instances, [])
        <span style="color:#f92672">from</span> fuzzywuzzy <span style="color:#f92672">import</span> process
          
        maybe <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>extract(key, instances, limit<span style="color:#f92672">=</span>limit)
        <span style="color:#66d9ef">return</span> maybe
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_instances</span>(self):
        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>container:
            <span style="color:#66d9ef">for</span> instance <span style="color:#f92672">in</span> item[<span style="color:#ae81ff">2</span>]:
                <span style="color:#66d9ef">assert</span> self<span style="color:#f92672">.</span>search(instance) <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>match(
                    instance
                ), <span style="color:#e6db74">&#34;instance </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> not fit pattern </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (instance, item[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>pattern)
          
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_all</span>(self, as_string<span style="color:#f92672">=</span>True):
        <span style="color:#e6db74">&#34;&#34;&#34;, python2 will not show flags&#34;&#34;&#34;</span>
        result <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>container:
            pattern <span style="color:#f92672">=</span> str(item[<span style="color:#ae81ff">0</span>])[<span style="color:#ae81ff">10</span>:] <span style="color:#66d9ef">if</span> PY3 <span style="color:#66d9ef">else</span> item[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>pattern
            instances <span style="color:#f92672">=</span> item[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">or</span> []
            value <span style="color:#f92672">=</span> (
                <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;&#39;</span> <span style="color:#f92672">%</span> (item[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>__name__, (item[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>__doc__ <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>))
                <span style="color:#66d9ef">if</span> callable(item[<span style="color:#ae81ff">1</span>])
                <span style="color:#66d9ef">else</span> str(item[<span style="color:#ae81ff">1</span>])
            )
            value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (type(item[<span style="color:#ae81ff">1</span>]), value)
            result<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34; =&gt; &#34;</span><span style="color:#f92672">.</span>join((pattern, <span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">.</span>join(instances), value)))
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(result) <span style="color:#66d9ef">if</span> as_string <span style="color:#66d9ef">else</span> result
</code></pre></div></li>
</ol>
</li>
</ol>
</li>
<li>
<p>常用 User-Agent</p>
<ol>
<li>
<p>code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UA</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;Some common User-Agents for crawler.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    Android, iPhone, iPad, Firefox, Chrome, IE6, IE9&#34;&#34;&#34;</span>
       
    __slots__ <span style="color:#f92672">=</span> ()
    Android <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Linux; Android 5.1.1; Nexus 6 Build/LYZ28E) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Mobile Safari/537.36&#34;</span>
    iPhone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/56.0.2924.75 Mobile/14E5239e Safari/602.1&#34;</span>
    iPad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (iPad; CPU OS 9_1 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13B143 Safari/601.1&#34;</span>
    Firefox <span style="color:#f92672">=</span> (
        <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0&#34;</span>
    )
    Chrome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&#34;</span>
    IE6 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)&#34;</span>
    IE9 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0;&#34;</span>
    WECHAT_ANDROID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Linux; Android 5.0; SM-N9100 Build/LRX21V) &gt; AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 &gt; Chrome/37.0.0.0 Mobile Safari/537.36 &gt; MicroMessenger/6.0.2.56_r958800.520 NetType/WIFI&#34;</span>
    WECHAT_IOS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (iPhone; CPU iPhone OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Mobile/9B176 MicroMessenger/4.3.2&#34;</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>简单计时器装置, 支持装饰器, 函数闭包调用, 全局调用</p>
<ol>
<li>
<p>原理就是通过 sys._getframe(stack_level).f_code.co_name 拿到栈信息</p>
</li>
<li>
<p>然后默认在 delete (也就是被回收时), 打印经过的时间, 或者调用 timer.x 打印一次</p>
</li>
<li>
<p>timeit.default_timer 比 time.time 更合理</p>
</li>
<li>
<p>具体用法见类文档中的实例.</p>
</li>
<li>
<p>PS: 这个类写的时候还没有 <strong>PySnooper</strong> 这个库, 否则就会参考它里面的方式来实现, 毕竟直接在栈信息里到处转悠还是比较容易出错的.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Timer</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Usage:
</span><span style="color:#e6db74">        init Timer anywhere:
</span><span style="color:#e6db74">            such as head of function, or head of module, then it will show log after del it by gc.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        :param name: be used in log or None.
</span><span style="color:#e6db74">        :param log_func: some function to show process.
</span><span style="color:#e6db74">        :param default_timer: use `timeit.default_timer` by default.
</span><span style="color:#e6db74">        :param rounding: None, or seconds will be round(xxx, rounding)
</span><span style="color:#e6db74">        :param readable: None, or use `timepass`: readable(cost_seconds) -&gt; 00:00:01,234
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">            from torequests.utils import Timer
</span><span style="color:#e6db74">            import time
</span><span style="color:#e6db74">            Timer()
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">            @Timer.watch()
</span><span style="color:#e6db74">            def test(a=1):
</span><span style="color:#e6db74">                Timer()
</span><span style="color:#e6db74">                time.sleep(1)
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">                def test_inner():
</span><span style="color:#e6db74">                    t = Timer(&#39;test_non_del&#39;)
</span><span style="color:#e6db74">                    time.sleep(1)
</span><span style="color:#e6db74">                    t.x
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">                test_inner()
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">            test(3)
</span><span style="color:#e6db74">            time.sleep(1)
</span><span style="color:#e6db74">            # [2018-03-10 02:16:48]: Timer [00:00:01]: test_non_del, start at 2018-03-10 02:16:47.
</span><span style="color:#e6db74">            # [2018-03-10 02:16:48]: Timer [00:00:02]: test(a=3), start at 2018-03-10 02:16:46.
</span><span style="color:#e6db74">            # [2018-03-10 02:16:48]: Timer [00:00:02]: test(3), start at 2018-03-10 02:16:46.
</span><span style="color:#e6db74">            # [2018-03-10 02:16:49]: Timer [00:00:03]: &lt;module&gt;: __main__ (temp_code.py), start at 2018-03-10 02:16:46.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> __init__(
        self,
        name<span style="color:#f92672">=</span>None,
        log_func<span style="color:#f92672">=</span>None,
        default_timer<span style="color:#f92672">=</span>None,
        rounding<span style="color:#f92672">=</span>None,
        readable<span style="color:#f92672">=</span>None,
        log_after_del<span style="color:#f92672">=</span>True,
        stack_level<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
    ):
        readable <span style="color:#f92672">=</span> readable <span style="color:#f92672">or</span> timepass
        self<span style="color:#f92672">.</span>_log_after_del <span style="color:#f92672">=</span> False
        self<span style="color:#f92672">.</span>start_at <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        uid <span style="color:#f92672">=</span> md5(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>start_at, id(self)))
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> name:
            f_name <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe(stack_level)<span style="color:#f92672">.</span>f_code<span style="color:#f92672">.</span>co_name
            f_local <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe(stack_level)<span style="color:#f92672">.</span>f_locals
            <span style="color:#66d9ef">if</span> f_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&lt;module&gt;&#34;</span>:
                f_vars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (
                    f_local<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;__name__&#34;</span>),
                    os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>split(f_local<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;__file__&#34;</span>))[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
                )
                <span style="color:#75715e"># f_vars = f_vars.replace(&#39; __main__&#39;, &#39;&#39;)</span>
            <span style="color:#66d9ef">else</span>:
                f_vars <span style="color:#f92672">=</span> (
                    <span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span>
                    <span style="color:#f92672">%</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(
                        [
                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (i, repr(f_local[i]))
                            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> sorted(f_local<span style="color:#f92672">.</span>keys())
                        ]
                    )
                    <span style="color:#66d9ef">if</span> f_local
                    <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;()&#34;</span>
                )
            <span style="color:#66d9ef">if</span> self <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> f_local<span style="color:#f92672">.</span>values():
                <span style="color:#75715e"># add self to name space for __del__ way.</span>
                sys<span style="color:#f92672">.</span>_getframe(stack_level)<span style="color:#f92672">.</span>f_locals<span style="color:#f92672">.</span>update(<span style="color:#f92672">**</span>{uid: self})
            name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (f_name, f_vars)
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>log_func <span style="color:#f92672">=</span> log_func
        self<span style="color:#f92672">.</span>timer <span style="color:#f92672">=</span> default_timer <span style="color:#f92672">or</span> timeit<span style="color:#f92672">.</span>default_timer
        self<span style="color:#f92672">.</span>rounding <span style="color:#f92672">=</span> rounding
        self<span style="color:#f92672">.</span>readable <span style="color:#f92672">=</span> readable
        self<span style="color:#f92672">.</span>start_timer <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>timer()
        self<span style="color:#f92672">.</span>_log_after_del <span style="color:#f92672">=</span> log_after_del
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">string</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Only return the expect_string quietly.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>tick()
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Call self.log_func(self) and return expect_string.&#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>_log_after_del <span style="color:#f92672">=</span> False
        passed_string <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>string
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>log_func:
            self<span style="color:#f92672">.</span>log_func(self)
        <span style="color:#66d9ef">else</span>:
            print_info(
                <span style="color:#e6db74">&#34;Timer [</span><span style="color:#e6db74">%(passed)s</span><span style="color:#e6db74">]: </span><span style="color:#e6db74">%(name)s</span><span style="color:#e6db74">, start at </span><span style="color:#e6db74">%(start)s</span><span style="color:#e6db74">.&#34;</span>
                <span style="color:#f92672">%</span> (
                    dict(
                        name<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>name, start<span style="color:#f92672">=</span>ttime(self<span style="color:#f92672">.</span>start_at), passed<span style="color:#f92672">=</span>passed_string
                    )
                )
            )
        <span style="color:#66d9ef">return</span> passed_string
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">passed</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Return the cost_seconds after starting up.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>timer() <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>start_timer
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tick</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Return the time cost string as expect.&#34;&#34;&#34;</span>
        string <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>passed
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>rounding:
            string <span style="color:#f92672">=</span> round(string)
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>readable:
            string <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>readable(string)
        <span style="color:#66d9ef">return</span> string
       
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">watch</span>(<span style="color:#f92672">*</span>timer_args, <span style="color:#f92672">**</span>timer_kwargs):
        <span style="color:#e6db74">&#34;&#34;&#34;Decorator for Timer.&#34;&#34;&#34;</span>
       
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(function):
            <span style="color:#a6e22e">@wraps</span>(function)
            <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inner</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
                args1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(map(repr, args)) <span style="color:#66d9ef">if</span> args <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>
                kwargs1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(
                    [<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (i, repr(kwargs[i])) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> sorted(kwargs<span style="color:#f92672">.</span>keys())]
                )
                arg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(filter(None, [args1, kwargs1]))
                name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">(</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (function<span style="color:#f92672">.</span>__name__, arg)
                _ <span style="color:#f92672">=</span> Timer(name<span style="color:#f92672">=</span>name, <span style="color:#f92672">*</span>timer_args, <span style="color:#f92672">**</span>timer_kwargs)
                result <span style="color:#f92672">=</span> function(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
                <span style="color:#66d9ef">return</span> result
       
            <span style="color:#66d9ef">return</span> inner
       
        <span style="color:#66d9ef">return</span> wrapper
       
    <span style="color:#66d9ef">def</span> __del__(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_log_after_del:
            <span style="color:#75715e"># not be called by self.x yet.</span>
            self<span style="color:#f92672">.</span>x
       
    <span style="color:#66d9ef">def</span> __enter__(self):
        <span style="color:#66d9ef">return</span> self
       
    <span style="color:#66d9ef">def</span> __exit__(self, <span style="color:#f92672">*</span>args):
        self<span style="color:#f92672">.</span>x
</code></pre></div></li>
</ol>
</li>
<li>
<p>简简单单的剪贴板辅助工具</p>
<ol>
<li>
<p>用途很明显, 开启剪贴板 watcher, 会在剪贴板内容发生改变的时候触发 callback</p>
</li>
<li>
<p>默认 callback 为原封不动打印内容+换行</p>
</li>
<li>
<p>支持异步调用, 即不阻塞主线程.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClipboardWatcher</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Watch clipboard with `pyperclip`, run callback while changed.&#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> __init__(self, interval<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, callback<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>pyperclip <span style="color:#f92672">=</span> try_import(<span style="color:#e6db74">&#34;pyperclip&#34;</span>)
        self<span style="color:#f92672">.</span>interval <span style="color:#f92672">=</span> interval
        self<span style="color:#f92672">.</span>callback <span style="color:#f92672">=</span> callback <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>default_callback
        self<span style="color:#f92672">.</span>temp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>current
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Return the current clipboard content.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pyperclip<span style="color:#f92672">.</span>paste()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(self, text):
        <span style="color:#e6db74">&#34;&#34;&#34;Rewrite the current clipboard content.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>pyperclip<span style="color:#f92672">.</span>copy(text)
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">current</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Return the current clipboard content.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>read()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">default_callback</span>(self, text):
        <span style="color:#e6db74">&#34;&#34;&#34;Default clean the </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n in text.&#34;&#34;&#34;</span>
        text <span style="color:#f92672">=</span> text<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> text
        flush_print(text, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>)
        <span style="color:#66d9ef">return</span> text
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">watch</span>(self, limit<span style="color:#f92672">=</span>None, timeout<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;Block method to watch the clipboard changing.&#34;&#34;&#34;</span>
        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> timeout <span style="color:#f92672">or</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time <span style="color:#f92672">&lt;</span> timeout:
            new <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>read()
            <span style="color:#66d9ef">if</span> new <span style="color:#f92672">!=</span> self<span style="color:#f92672">.</span>temp:
                count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
                self<span style="color:#f92672">.</span>callback(new)
                <span style="color:#66d9ef">if</span> count <span style="color:#f92672">==</span> limit:
                    <span style="color:#66d9ef">break</span>
            self<span style="color:#f92672">.</span>temp <span style="color:#f92672">=</span> new
            time<span style="color:#f92672">.</span>sleep(self<span style="color:#f92672">.</span>interval)
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Return self.watch()&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>watch()
       
    <span style="color:#a6e22e">@threads</span>(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">watch_async</span>(self, limit<span style="color:#f92672">=</span>None, timeout<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;Non-block method to watch the clipboard changing.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>watch(limit<span style="color:#f92672">=</span>limit, timeout<span style="color:#f92672">=</span>timeout)
</code></pre></div></li>
</ol>
</li>
<li>
<p>常用的本地数据持久化功能</p>
<ol>
<li>
<p>用途很简单, 就是想通过 key value 的方式在本地存放一点数据</p>
</li>
<li>
<p>之前我比较习惯用的是 <a href="https://pypi.org/project/sqlitedict/">sqlitedict</a> 这个库, 性能没的说, 不过老得清理 sqlite 缓存 (VACUMM)</p>
</li>
<li>
<p>默认路径会放在 Windows / linux 的 User 目录下, 支持 pickle 存储和 json 存储</p>
</li>
<li>
<p>早期经常用这个来存储配置文件或者做简单的本地缓存, 现在用的时候少了, 毕竟没解决好多进程的竞态问题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Saver</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Simple object persistent toolkit with pickle/json,
</span><span style="color:#e6db74">    if only you don&#39;t care the performance and security.
</span><span style="color:#e6db74">    **Do not set the key startswith &#34;_&#34;**
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    :param path: if not set, will be ~/_saver.db. print(self._path) to show it.
</span><span style="color:#e6db74">        Set pickle&#39;s protocol &lt; 3 for compatibility between python2/3,
</span><span style="color:#e6db74">        but use -1 for performance and some other optimizations.
</span><span style="color:#e6db74">    :param save_mode: pickle / json.
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss = Saver()
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss._path
</span><span style="color:#e6db74">    &#39;/home/work/_saver.json&#39;
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss.a = 1
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss[&#39;b&#39;] = 2
</span><span style="color:#e6db74">    &gt;&gt;&gt; str(ss)
</span><span style="color:#e6db74">    {&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 3, &#39;d&#39;: 4}
</span><span style="color:#e6db74">    &gt;&gt;&gt; del ss.b
</span><span style="color:#e6db74">    &gt;&gt;&gt; str(ss)
</span><span style="color:#e6db74">    &#34;{&#39;a&#39;: 1, &#39;c&#39;: 3, &#39;d&#39;: 4}&#34;
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss._update({&#39;c&#39;: 3, &#39;d&#39;: 4})
</span><span style="color:#e6db74">    &gt;&gt;&gt; ss
</span><span style="color:#e6db74">    Saver(path=&#34;/home/work/_saver.json&#34;){&#39;a&#39;: 1, &#39;c&#39;: 3, &#39;d&#39;: 4}
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
       
    _instances <span style="color:#f92672">=</span> {}
    _locks <span style="color:#f92672">=</span> {}
    _protected_keys <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;_auto_backup&#34;</span>,
        <span style="color:#e6db74">&#34;_lock&#34;</span>,
        <span style="color:#e6db74">&#34;_path&#34;</span>,
        <span style="color:#e6db74">&#34;_saver_args&#34;</span>,
        <span style="color:#e6db74">&#34;_save_mode&#34;</span>,
        <span style="color:#e6db74">&#34;_cache&#34;</span>,
        <span style="color:#e6db74">&#34;__getitem__&#34;</span>,
        <span style="color:#e6db74">&#34;_keys&#34;</span>,
        <span style="color:#e6db74">&#34;_values&#34;</span>,
        <span style="color:#e6db74">&#34;__getattr__&#34;</span>,
        <span style="color:#e6db74">&#34;__len__&#34;</span>,
        <span style="color:#e6db74">&#34;_popitem&#34;</span>,
        <span style="color:#e6db74">&#34;_shutdown&#34;</span>,
        <span style="color:#e6db74">&#34;__setitem__&#34;</span>,
        <span style="color:#e6db74">&#34;__delitem__&#34;</span>,
        <span style="color:#e6db74">&#34;_save_obj&#34;</span>,
        <span style="color:#e6db74">&#34;_get&#34;</span>,
        <span style="color:#e6db74">&#34;__dict__&#34;</span>,
        <span style="color:#e6db74">&#34;_clear&#34;</span>,
        <span style="color:#e6db74">&#34;_locks&#34;</span>,
        <span style="color:#e6db74">&#34;__weakref__&#34;</span>,
        <span style="color:#e6db74">&#34;_items&#34;</span>,
        <span style="color:#e6db74">&#34;__module__&#34;</span>,
        <span style="color:#e6db74">&#34;_pop&#34;</span>,
        <span style="color:#e6db74">&#34;__contains__&#34;</span>,
        <span style="color:#e6db74">&#34;_load&#34;</span>,
        <span style="color:#e6db74">&#34;_save&#34;</span>,
        <span style="color:#e6db74">&#34;_update&#34;</span>,
        <span style="color:#e6db74">&#34;_set&#34;</span>,
        <span style="color:#e6db74">&#34;_protected_keys&#34;</span>,
        <span style="color:#e6db74">&#34;_instances&#34;</span>,
        <span style="color:#e6db74">&#34;_get_home_path&#34;</span>,
        <span style="color:#e6db74">&#34;_save_back_up&#34;</span>,
    }
    _protected_keys <span style="color:#f92672">=</span> _protected_keys <span style="color:#f92672">|</span> set(object<span style="color:#f92672">.</span>__dict__<span style="color:#f92672">.</span>keys())
       
    <span style="color:#66d9ef">def</span> __new__(cls, path<span style="color:#f92672">=</span>None, save_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;json&#34;</span>, auto_backup<span style="color:#f92672">=</span>False, <span style="color:#f92672">**</span>saver_args):
        <span style="color:#75715e"># BORG</span>
        path <span style="color:#f92672">=</span> path <span style="color:#f92672">or</span> cls<span style="color:#f92672">.</span>_get_home_path(save_mode<span style="color:#f92672">=</span>save_mode)
        <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>_instances<span style="color:#f92672">.</span>setdefault(path, super(Saver, cls)<span style="color:#f92672">.</span>__new__(cls))
       
    <span style="color:#66d9ef">def</span> __init__(self, path<span style="color:#f92672">=</span>None, save_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;json&#34;</span>, auto_backup<span style="color:#f92672">=</span>False, <span style="color:#f92672">**</span>saver_args):
        super(Saver, self)<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>_auto_backup <span style="color:#f92672">=</span> auto_backup
        self<span style="color:#f92672">.</span>_lock <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>_locks<span style="color:#f92672">.</span>setdefault(path, Lock())
        self<span style="color:#f92672">.</span>_path <span style="color:#f92672">=</span> path <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>_get_home_path(save_mode<span style="color:#f92672">=</span>save_mode)
        self<span style="color:#f92672">.</span>_saver_args <span style="color:#f92672">=</span> saver_args
        self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">=</span> save_mode
        self<span style="color:#f92672">.</span>_cache <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_load()
       
    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_home_path</span>(cls, save_mode<span style="color:#f92672">=</span>None):
        home <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>expanduser(<span style="color:#e6db74">&#34;~&#34;</span>)
        <span style="color:#66d9ef">if</span> save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;json&#34;</span>:
            ext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>
        <span style="color:#66d9ef">elif</span> save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pickle&#34;</span>:
            ext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pkl&#34;</span>
        <span style="color:#66d9ef">else</span>:
            ext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;db&#34;</span>
        file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;_saver.</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> ext
        path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(home, file_name)
        <span style="color:#66d9ef">return</span> path
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save_back_up</span>(self):
        <span style="color:#66d9ef">with</span> open(self<span style="color:#f92672">.</span>_path, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f_raw:
            <span style="color:#66d9ef">with</span> open(self<span style="color:#f92672">.</span>_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.bk&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f_bk:
                f_bk<span style="color:#f92672">.</span>write(f_raw<span style="color:#f92672">.</span>read())
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save_obj</span>(self, obj):
        mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wb&#34;</span> <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pickle&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;w&#34;</span>
        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_lock:
            <span style="color:#66d9ef">with</span> open(self<span style="color:#f92672">.</span>_path, mode) <span style="color:#66d9ef">as</span> f:
                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;json&#34;</span>:
                    json<span style="color:#f92672">.</span>dump(obj, f, <span style="color:#f92672">**</span>self<span style="color:#f92672">.</span>_saver_args)
                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pickle&#34;</span>:
                    pickle<span style="color:#f92672">.</span>dump(obj, f, <span style="color:#f92672">**</span>self<span style="color:#f92672">.</span>_saver_args)
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_auto_backup:
                self<span style="color:#f92672">.</span>_save_back_up()
        <span style="color:#66d9ef">return</span> obj
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_load</span>(self):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(self<span style="color:#f92672">.</span>_path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>getsize(self<span style="color:#f92672">.</span>_path)):
            cache <span style="color:#f92672">=</span> {}
            self<span style="color:#f92672">.</span>_save_obj(cache)
            <span style="color:#66d9ef">return</span> cache
        mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rb&#34;</span> <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pickle&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;r&#34;</span>
        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_lock:
            <span style="color:#66d9ef">with</span> open(self<span style="color:#f92672">.</span>_path, mode) <span style="color:#66d9ef">as</span> f:
                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;json&#34;</span>:
                    <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>load(f)
                <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pickle&#34;</span>:
                    <span style="color:#66d9ef">return</span> pickle<span style="color:#f92672">.</span>load(f)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_save_obj(self<span style="color:#f92672">.</span>_cache)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_set</span>(self, key, value):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_save_mode <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;json&#34;</span>:
            <span style="color:#66d9ef">try</span>:
                json<span style="color:#f92672">.</span>dumps(value)
            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">TypeError</span>:
                Config<span style="color:#f92672">.</span>utils_logger<span style="color:#f92672">.</span>warning(
                    <span style="color:#e6db74">&#34;Saver._set(</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">) failed: bad type, using str(value) instead.&#34;</span>
                    <span style="color:#f92672">%</span> (key, value)
                )
                value <span style="color:#f92672">=</span> str(value)
        self<span style="color:#f92672">.</span>_cache[key] <span style="color:#f92672">=</span> value
        self<span style="color:#f92672">.</span>_save()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get</span>(self, key, default<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>get(key, default)
       
    <span style="color:#66d9ef">def</span> __setattr__(self, key, value):
        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_protected_keys:
            object<span style="color:#f92672">.</span>__setattr__(self, key, value)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>_set(key, value)
       
    <span style="color:#66d9ef">def</span> __getattr__(self, key):
        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_protected_keys:
            <span style="color:#66d9ef">return</span> object<span style="color:#f92672">.</span>__getattribute__(self, key)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_get(key)
       
    <span style="color:#66d9ef">def</span> __contains__(self, key):
        <span style="color:#66d9ef">return</span> key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_cache
       
    <span style="color:#66d9ef">def</span> __delattr__(self, key):
        self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>pop(key, None)
        self<span style="color:#f92672">.</span>_save()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dir__</span>(self):
        <span style="color:#66d9ef">return</span> dir(object)
       
    <span style="color:#66d9ef">def</span> __len__(self):
        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>_cache)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_clear</span>(self):
        self<span style="color:#f92672">.</span>_cache <span style="color:#f92672">=</span> {}
        self<span style="color:#f92672">.</span>_save()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_shutdown</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_auto_backup:
            os<span style="color:#f92672">.</span>remove(self<span style="color:#f92672">.</span>_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.bk&#34;</span>)
        <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>remove(self<span style="color:#f92672">.</span>_path)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_keys</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>keys()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_items</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>items()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_values</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>values()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_pop</span>(self, key, default<span style="color:#f92672">=</span>None):
        result <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>pop(key, default)
        self<span style="color:#f92672">.</span>_save()
        <span style="color:#66d9ef">return</span> result
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_popitem</span>(self):
        result <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>popitem()
        self<span style="color:#f92672">.</span>_save()
        <span style="color:#66d9ef">return</span> result
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_update</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>update(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        self<span style="color:#f92672">.</span>_save()
       
    <span style="color:#66d9ef">def</span> __getitem__(self, key):
        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_cache:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_get(key)
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>
       
    <span style="color:#66d9ef">def</span> __setitem__(self, key, value):
        self<span style="color:#f92672">.</span>_set(key, value)
       
    <span style="color:#66d9ef">def</span> __delitem__(self, key):
        self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>pop(key, None)
        self<span style="color:#f92672">.</span>_save()
       
    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> str(self<span style="color:#f92672">.</span>_cache)
       
    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Saver(path=&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;)</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>_path, reprlib<span style="color:#f92672">.</span>repr(self<span style="color:#f92672">.</span>_cache))
</code></pre></div></li>
</ol>
</li>
<li>
<p>估算一大串无序数字的平均间隔</p>
<ol>
<li>
<p>当初写这个的使用场景实际是在一万多篇文章的发布时间里, 找出这个作者的发布规律, 因为只是估算个大概, 所以不想导入机器学习相关的第三方库, 就简单实现了一个</p>
</li>
<li>
<p>计算方法: 先对序列排序, 然后相邻数字求差, 将差值序列排序取中位数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">guess_interval</span>(nums, accuracy<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Given a seq of number, return the median, only calculate interval &gt;= accuracy.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        from torequests.utils import guess_interval
</span><span style="color:#e6db74">        import random
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        seq = [random.randint(1, 100) for i in range(20)]
</span><span style="color:#e6db74">        print(guess_interval(seq, 5))
</span><span style="color:#e6db74">        # sorted_seq: [2, 10, 12, 19, 19, 29, 30, 32, 38, 40, 41, 54, 62, 69, 75, 79, 82, 88, 97, 99]
</span><span style="color:#e6db74">        # diffs: [8, 7, 10, 6, 13, 8, 7, 6, 6, 9]
</span><span style="color:#e6db74">        # median: 8
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> nums:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
    nums <span style="color:#f92672">=</span> sorted([int(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> nums])
    <span style="color:#66d9ef">if</span> len(nums) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">return</span> nums[<span style="color:#ae81ff">0</span>]
    diffs <span style="color:#f92672">=</span> [nums[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> nums[i] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(nums) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)]
    diffs <span style="color:#f92672">=</span> [item <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> diffs <span style="color:#66d9ef">if</span> item <span style="color:#f92672">&gt;=</span> accuracy]
    sorted_diff <span style="color:#f92672">=</span> sorted(diffs)
    result <span style="color:#f92672">=</span> sorted_diff[len(diffs) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>]
    <span style="color:#66d9ef">return</span> result
</code></pre></div></li>
</ol>
</li>
<li>
<p>将字符串按指定方式解析成多维列表</p>
<ol>
<li>
<p>用的比较少, 用法见 doc 吧</p>
</li>
<li>
<p>主要就是把多层 for 循环的代码稍微节省一下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> re
       
       
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_re_split_mixin</span>(string, sep, reg<span style="color:#f92672">=</span>False):
    <span style="color:#66d9ef">if</span> reg:
        <span style="color:#66d9ef">return</span> re<span style="color:#f92672">.</span>split(sep, string)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> string<span style="color:#f92672">.</span>split(sep)
       
       
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_n</span>(string, seps, reg<span style="color:#f92672">=</span>False):
    <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;&#34;&#34;Split strings into n-dimensional list.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        from torequests.utils import split_n
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        ss = &#39;&#39;&#39;a b c  d e f  1 2 3  4 5 6
</span><span style="color:#e6db74">        a b c  d e f  1 2 3  4 5 6
</span><span style="color:#e6db74">        a b c  d e f  1 2 3  4 5 6&#39;&#39;&#39;
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        print(split_n(ss, (&#39;\n&#39;, &#39;  &#39;, &#39; &#39;)))
</span><span style="color:#e6db74">        # [[[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;d&#39;, &#39;e&#39;, &#39;f&#39;], [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;], [&#39;4&#39;, &#39;5&#39;, &#39;6&#39;]], [[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;d&#39;, &#39;e&#39;, &#39;f&#39;], [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;], [&#39;4&#39;, &#39;5&#39;, &#39;6&#39;]], [[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], [&#39;d&#39;, &#39;e&#39;, &#39;f&#39;], [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;], [&#39;4&#39;, &#39;5&#39;, &#39;6&#39;]]]
</span><span style="color:#e6db74">        print(split_n(ss, [&#39;\s+&#39;], reg=1))
</span><span style="color:#e6db74">        # [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;]
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    deep <span style="color:#f92672">=</span> len(seps)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> deep:
        <span style="color:#66d9ef">return</span> string
    <span style="color:#66d9ef">return</span> [split_n(i, seps[<span style="color:#ae81ff">1</span>:]) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> _re_split_mixin(string, seps[<span style="color:#ae81ff">0</span>], reg<span style="color:#f92672">=</span>reg)]
</code></pre></div></li>
</ol>
</li>
<li>
<p>将一个函数丢到后台执行, 并且主线程如果跑完, 不要等这个线程完成就可以结束</p>
<ol>
<li>
<p>说白了就是将一个同步阻塞的函数, 丢到一个新线程里跑</p>
</li>
<li>
<p>默认情况下, 这个现成没跑完, 主线程是无法退出的</p>
</li>
<li>
<p>但是如果设置了 Thread.daemon = True, 主线程结束时不需要阻塞等待该线程结束</p>
</li>
<li>
<p>这个是有点水&hellip; 还不如 atexit 有用&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bg</span>(func):
    <span style="color:#e6db74">&#34;&#34;&#34;Run a function in background, will not block main thread&#39;s exit.(thread.daemon=True)
</span><span style="color:#e6db74">    ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        from torequests.utils import bg, print_info
</span><span style="color:#e6db74">        import time
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        def test1(n):
</span><span style="color:#e6db74">            time.sleep(n)
</span><span style="color:#e6db74">            print_info(n, &#39;done&#39;)
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        @bg
</span><span style="color:#e6db74">        def test2(n):
</span><span style="color:#e6db74">            time.sleep(n)
</span><span style="color:#e6db74">            print_info(n, &#39;done&#39;)
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        test3 = bg(test1)
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        test2(1)
</span><span style="color:#e6db74">        test3(1)
</span><span style="color:#e6db74">        print_info(&#39;not be blocked&#39;)
</span><span style="color:#e6db74">        time.sleep(2)
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        # [2018-06-12 23:46:19](L81): not be blocked
</span><span style="color:#e6db74">        # [2018-06-12 23:46:20](L81): 1 done
</span><span style="color:#e6db74">        # [2018-06-12 23:46:20](L81): 1 done
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
       
    <span style="color:#a6e22e">@wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        t <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>func, args<span style="color:#f92672">=</span>args, kwargs<span style="color:#f92672">=</span>kwargs)
        <span style="color:#75715e"># t.daemon = True</span>
        t<span style="color:#f92672">.</span>start()
        <span style="color:#66d9ef">return</span> t
       
    <span style="color:#66d9ef">return</span> wrapper
</code></pre></div></li>
</ol>
</li>
<li>
<p>一个简单的倒计时</p>
<ol>
<li>
<p>正常情况下是阻塞主线程并不换行打印剩余秒数.</p>
</li>
<li>
<p>常规用途是在爬虫的两次请求之间显示剩余时间</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown</span>(
    seconds<span style="color:#f92672">=</span>None,
    block<span style="color:#f92672">=</span>True,
    interval<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
    daemon<span style="color:#f92672">=</span>True,
    tick_callback<span style="color:#f92672">=</span>None,
    finish_callback<span style="color:#f92672">=</span>None,
):
    <span style="color:#e6db74">&#34;&#34;&#34;Run a countdown function to wait something, similar to threading.Timer,
</span><span style="color:#e6db74">     but will show the detail tick by tick_callback.
</span><span style="color:#e6db74">     ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        from torequests.utils import countdown
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        countdown(3)
</span><span style="color:#e6db74">        # 3 2 1 
</span><span style="color:#e6db74">        # countdown finished [3 seconds]: 2018-06-13 00:12:55 =&gt; 2018-06-13 00:12:58.
</span><span style="color:#e6db74">        countdown(&#39;2018-06-13 00:13:29&#39;)
</span><span style="color:#e6db74">        # 10 9 8 7 6 5 4 3 2 1 
</span><span style="color:#e6db74">        # countdown finished [10 seconds]: 2018-06-13 00:13:18 =&gt; 2018-06-13 00:13:28.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">default_tick_callback</span>(s, seconds, <span style="color:#f92672">*</span>args):
        flush_print(s, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34; &#34;</span>)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">default_finish_callback</span>(seconds, start_time):
        flush_print()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cd</span>(seconds, interval):
        <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> range(seconds, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span>interval):
            tick_callback(s, seconds, interval)
            time<span style="color:#f92672">.</span>sleep(interval)
        <span style="color:#66d9ef">if</span> callable(finish_callback):
            finish_callback(seconds, start_time)
       
    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    tick_callback <span style="color:#f92672">=</span> tick_callback <span style="color:#f92672">or</span> default_tick_callback
    finish_callback <span style="color:#f92672">=</span> (
        default_finish_callback <span style="color:#66d9ef">if</span> finish_callback <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> finish_callback
    )
       
    <span style="color:#66d9ef">if</span> unicode(seconds)<span style="color:#f92672">.</span>isdigit():
        seconds <span style="color:#f92672">=</span> int(seconds)
    <span style="color:#66d9ef">elif</span> isinstance(seconds, (unicode, str)):
        seconds <span style="color:#f92672">=</span> int(ptime(seconds) <span style="color:#f92672">-</span> time<span style="color:#f92672">.</span>time())
    t <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>cd, args<span style="color:#f92672">=</span>(seconds, interval))
    t<span style="color:#f92672">.</span>daemon <span style="color:#f92672">=</span> daemon
    t<span style="color:#f92672">.</span>start()
    <span style="color:#66d9ef">if</span> block:
        t<span style="color:#f92672">.</span>join()
</code></pre></div></li>
</ol>
</li>
<li>
<p>乞丐版进度条</p>
<ol>
<li>
<p>就是想做个不需要太多依赖, 只要稍微看看大体进度</p>
</li>
<li>
<p>用法见 Basic Usage</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">flush_print</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Like print_function at python3, support flush, but not support file.
</span><span style="color:#e6db74">    :param sep: space by default
</span><span style="color:#e6db74">    :param end: &#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n&#39; by default
</span><span style="color:#e6db74">    :param flush: True by default
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">     ::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        import time
</span><span style="color:#e6db74">        from torequests.utils import flush_print
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        flush_print(&#34;=&#34; * 10)
</span><span style="color:#e6db74">        for _ in range(10):
</span><span style="color:#e6db74">            time.sleep(0.2)
</span><span style="color:#e6db74">            flush_print(&#34;=&#34;, sep=&#34;&#34;, end=&#34;&#34;)
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#75715e"># PY2 raise SyntaxError for : def flush_print(*args, sep=&#39;&#39;, end=&#39;&#39;):</span>
    sep, end, flush <span style="color:#f92672">=</span> (
        kwargs<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;sep&#34;</span>, <span style="color:#e6db74">&#34; &#34;</span>),
        kwargs<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;end&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>),
        kwargs<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#34;flush&#34;</span>, <span style="color:#ae81ff">1</span>),
    )
    string <span style="color:#f92672">=</span> sep<span style="color:#f92672">.</span>join((unicode(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> args))
    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (string, end))
    <span style="color:#66d9ef">if</span> flush:
        sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
       
       
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProgressBar</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Simple progress bar.
</span><span style="color:#e6db74">        :param size: total counts of calling ProgressBar.x.
</span><span style="color:#e6db74">        :param length: length of print log.
</span><span style="color:#e6db74">        :param sig: string of each printing log.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    Basic Usage::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        pb = ProgressBar(50, 10)
</span><span style="color:#e6db74">        for _ in range(50):
</span><span style="color:#e6db74">            time.sleep(0.1)
</span><span style="color:#e6db74">            pb.x
</span><span style="color:#e6db74">        print(&#34;current completion rate:&#34;, pb.completion_rate)
</span><span style="color:#e6db74">        # ==========
</span><span style="color:#e6db74">        # ==========
</span><span style="color:#e6db74">        # current completion rate: 1.0
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> __init__(self, size, length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, sig<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;=&#34;</span>):
        self<span style="color:#f92672">.</span>size <span style="color:#f92672">=</span> size <span style="color:#f92672">or</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>length <span style="color:#f92672">=</span> length
        self<span style="color:#f92672">.</span>sig <span style="color:#f92672">=</span> sig
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>last_print <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>printed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">if</span> size:
            <span style="color:#75715e"># use Fraction for the deviation of division</span>
            self<span style="color:#f92672">.</span>chunk <span style="color:#f92672">=</span> Fraction(self<span style="color:#f92672">.</span>size, self<span style="color:#f92672">.</span>length)
            flush_print(self<span style="color:#f92672">.</span>sig <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>length)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>chunk <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, step):
        <span style="color:#75715e"># ensure step &gt;= 0</span>
        self<span style="color:#f92672">.</span>current <span style="color:#f92672">+=</span> step
        count <span style="color:#f92672">=</span> int((self<span style="color:#f92672">.</span>current <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>last_print) <span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>chunk)
        <span style="color:#66d9ef">if</span> count <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>printed
        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(count):
            self<span style="color:#f92672">.</span>printed <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            flush_print(self<span style="color:#f92672">.</span>sig, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>)
        self<span style="color:#f92672">.</span>last_print <span style="color:#f92672">=</span> count <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>chunk <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>last_print
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>size:
            flush_print()
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>printed
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>add(<span style="color:#ae81ff">1</span>)
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">completion_rate</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>current <span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>size
</code></pre></div></li>
</ol>
</li>
<li>
<p>像 JS 那样的正则 match</p>
<ol>
<li>
<p>也就是匹配到就匹配, 不然就给空字符串, 只要别报错就好</p>
</li>
<li>
<p>也可以注册到 re 库里去</p>
</li>
<li>
<p>用法见 Basic Usage</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RegMatch</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;JS-like match object. Use index number to get groups, if not match or no group, will return &#39;&#39;.&#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> __init__(self, item):
        self<span style="color:#f92672">.</span>item <span style="color:#f92672">=</span> item
       
    <span style="color:#66d9ef">def</span> __getattr__(self, key, default<span style="color:#f92672">=</span>null):
        <span style="color:#66d9ef">return</span> getattr(self<span style="color:#f92672">.</span>item, key, default)
       
    <span style="color:#66d9ef">def</span> __getitem__(self, index):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>item <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(index, int):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">IndexError</span>
        <span style="color:#66d9ef">try</span>:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>item<span style="color:#f92672">.</span>group(index)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IndexError</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
       
    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_one</span>(cls, pattern, string, flags<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
        <span style="color:#e6db74">&#34;&#34;&#34;JS-like match object. Use index number to get groups, if not match or no group, will return &#39;&#39;.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        Basic Usage::
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">            &gt;&gt;&gt; from torequests.utils import find_one
</span><span style="color:#e6db74">            &gt;&gt;&gt; string = &#34;abcd&#34;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a.*&#34;, string)
</span><span style="color:#e6db74">            &lt;torequests.utils.RegMatch object at 0x0705F1D0&gt;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a.*&#34;, string)[0]
</span><span style="color:#e6db74">            &#39;abcd&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a.*&#34;, string)[1]
</span><span style="color:#e6db74">            &#39;&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a(.)&#34;, string)[0]
</span><span style="color:#e6db74">            &#39;ab&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a(.)&#34;, string)[1]
</span><span style="color:#e6db74">            &#39;b&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; find_one(&#34;a(.)&#34;, string)[2] or &#34;default&#34;
</span><span style="color:#e6db74">            &#39;default&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; import re
</span><span style="color:#e6db74">            &gt;&gt;&gt; item = find_one(&#34;a(B)(C)&#34;, string, flags=re.I | re.S)
</span><span style="color:#e6db74">            &gt;&gt;&gt; item
</span><span style="color:#e6db74">            &lt;torequests.utils.RegMatch object at 0x0705F1D0&gt;
</span><span style="color:#e6db74">            &gt;&gt;&gt; item[0]
</span><span style="color:#e6db74">            &#39;abc&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; item[1]
</span><span style="color:#e6db74">            &#39;b&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; item[2]
</span><span style="color:#e6db74">            &#39;c&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; item[3]
</span><span style="color:#e6db74">            &#39;&#39;
</span><span style="color:#e6db74">            &gt;&gt;&gt; # import re
</span><span style="color:#e6db74">            &gt;&gt;&gt; # re.findone = find_one
</span><span style="color:#e6db74">            &gt;&gt;&gt; register_re_findone()
</span><span style="color:#e6db74">            &gt;&gt;&gt; re.findone(&#39;a(b)&#39;, &#39;abcd&#39;)[1] or &#39;default&#39;
</span><span style="color:#e6db74">            &#39;b&#39;
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        item <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(pattern, string, flags<span style="color:#f92672">=</span>flags)
        <span style="color:#66d9ef">return</span> cls(item)
       
       
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_re_findone</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;import re; re.findone = find_one&#34;&#34;&#34;</span>
    re<span style="color:#f92672">.</span>findone <span style="color:#f92672">=</span> find_one
       
       
find_one <span style="color:#f92672">=</span> RegMatch<span style="color:#f92672">.</span>find_one
</code></pre></div></li>
</ol>
</li>
<li>
<p>线程安全的冷却池</p>
<ol>
<li>
<p>当初为了冷却代理避免反爬做的</p>
</li>
<li>
<p>初始化时指定一个 interval, 也就是没冷却够这个秒数的, 无法被取出</p>
</li>
<li>
<p>主要依靠的就是默认的 PriorityQueue, 天生线程安全</p>
</li>
<li>
<p>为了减少遍历, 所以每次按照上次使用时间来排序, 然后丢到队列里, 即越久未使用越靠前</p>
</li>
<li>
<p>队列头部的元素如果距离上次使用时间不超过 interval, 那么就按这个的差值 sleep</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TimeItem</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Used for Cooldown.&#34;&#34;&#34;</span>
    __slots__ <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#e6db74">&#39;use_at&#39;</span>)
       
    <span style="color:#66d9ef">def</span> __init__(self, data, use_at):
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> data
        self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">=</span> use_at
       
    <span style="color:#66d9ef">def</span> __hash__(self):
        <span style="color:#66d9ef">return</span> hash(self<span style="color:#f92672">.</span>data)
       
    <span style="color:#66d9ef">def</span> __gt__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">&gt;</span> other<span style="color:#f92672">.</span>use_at
       
    <span style="color:#66d9ef">def</span> __ge__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">&gt;=</span> other<span style="color:#f92672">.</span>use_at
       
    <span style="color:#66d9ef">def</span> __lt__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">&lt;</span> other<span style="color:#f92672">.</span>use_at
       
    <span style="color:#66d9ef">def</span> __le__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">&lt;=</span> other<span style="color:#f92672">.</span>use_at
       
    <span style="color:#66d9ef">def</span> __eq__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>use_at
       
    <span style="color:#66d9ef">def</span> __ne__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>use_at <span style="color:#f92672">!=</span> other<span style="color:#f92672">.</span>use_at
       
       
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cooldown</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;Thread-safe Cooldown toolkit.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    :param init_items: iterables to add into the default queue at first.
</span><span style="color:#e6db74">    :param interval: each item will cooldown `interval` seconds before return.
</span><span style="color:#e6db74">    :param born_at_now: if be set True, the item.use_at will be set time.time()
</span><span style="color:#e6db74">            instead of 0 when adding to queue at the first time.
</span><span style="color:#e6db74">       
</span><span style="color:#e6db74">    &gt;&gt;&gt; from torequests.logs import print_info
</span><span style="color:#e6db74">    &gt;&gt;&gt; cd = Cooldown(range(1, 3), interval=2)
</span><span style="color:#e6db74">    &gt;&gt;&gt; cd.add_items([3, 4])
</span><span style="color:#e6db74">    &gt;&gt;&gt; cd.add_item(5)
</span><span style="color:#e6db74">    &gt;&gt;&gt; for _ in range(7):
</span><span style="color:#e6db74">    ...     print_info(cd.get(1, &#39;timeout&#39;))
</span><span style="color:#e6db74">    [2019-01-17 01:50:59] pyld.py(152): 1
</span><span style="color:#e6db74">    [2019-01-17 01:50:59] pyld.py(152): 3
</span><span style="color:#e6db74">    [2019-01-17 01:50:59] pyld.py(152): 5
</span><span style="color:#e6db74">    [2019-01-17 01:50:59] pyld.py(152): 2
</span><span style="color:#e6db74">    [2019-01-17 01:50:59] pyld.py(152): 4
</span><span style="color:#e6db74">    [2019-01-17 01:51:00] pyld.py(152): timeout
</span><span style="color:#e6db74">    [2019-01-17 01:51:01] pyld.py(152): 1
</span><span style="color:#e6db74">    &gt;&gt;&gt; cd.size
</span><span style="color:#e6db74">    5
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
       
    <span style="color:#66d9ef">def</span> __init__(self, init_items<span style="color:#f92672">=</span>None, interval<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, born_at_now<span style="color:#f92672">=</span>False):
        self<span style="color:#f92672">.</span>interval <span style="color:#f92672">=</span> interval
        self<span style="color:#f92672">.</span>queue <span style="color:#f92672">=</span> PriorityQueue()
        self<span style="color:#f92672">.</span>use_at_function <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_now_timestamp <span style="color:#66d9ef">if</span> born_at_now <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">lambda</span>: <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>add_items(init_items <span style="color:#f92672">or</span> [])
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">size</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>qsize()
       
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">all_items</span>(self):
        <span style="color:#66d9ef">return</span> [item<span style="color:#f92672">.</span>data <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>queue]
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_now_timestamp</span>(self):
        <span style="color:#66d9ef">return</span> time<span style="color:#f92672">.</span>time()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_item</span>(self, item):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(item, TimeItem):
            item <span style="color:#f92672">=</span> TimeItem(item, self<span style="color:#f92672">.</span>use_at_function())
        self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>put(item)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_items</span>(self, items):
        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:
            self<span style="color:#f92672">.</span>add_item(item)
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_item</span>(self, item):
        self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>queue <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>queue <span style="color:#66d9ef">if</span> i<span style="color:#f92672">.</span>data <span style="color:#f92672">!=</span> item]
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>qsize()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_items</span>(self, items):
        self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>queue <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>queue <span style="color:#66d9ef">if</span> i<span style="color:#f92672">.</span>data <span style="color:#f92672">in</span> items]
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>qsize()
       
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, timeout<span style="color:#f92672">=</span>None, default<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">try</span>:
            start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
            <span style="color:#66d9ef">if</span> timeout <span style="color:#f92672">is</span> None:
                timeout <span style="color:#f92672">=</span> float(<span style="color:#e6db74">&#39;inf&#39;</span>)
            <span style="color:#66d9ef">while</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time <span style="color:#f92672">&lt;</span> timeout:
                item <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span>timeout)
                <span style="color:#66d9ef">if</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> item<span style="color:#f92672">.</span>use_at <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>interval:
                    self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>put(item)
                    wait_time <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>interval <span style="color:#f92672">-</span> (time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> item<span style="color:#f92672">.</span>use_at)
                    wait_time <span style="color:#f92672">=</span> min((wait_time, timeout))
                    time<span style="color:#f92672">.</span>sleep(wait_time)
                    <span style="color:#66d9ef">continue</span>
                item<span style="color:#f92672">.</span>use_at <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_now_timestamp()
                self<span style="color:#f92672">.</span>queue<span style="color:#f92672">.</span>put(item)
                <span style="color:#66d9ef">return</span> item<span style="color:#f92672">.</span>data
            <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">return</span> default
        <span style="color:#66d9ef">except</span> Empty:
            <span style="color:#66d9ef">return</span> default
</code></pre></div></li>
</ol>
</li>
<li>
<p>将 python2 和 python3 里常用的解析 URL 的库的名字统一化</p>
<ol>
<li>
<p>大部分工作其实 requests.compat 都做了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> PY2:
    <span style="color:#f92672">import</span> repr <span style="color:#f92672">as</span> reprlib
    <span style="color:#f92672">from</span> Queue <span style="color:#f92672">import</span> Empty, PriorityQueue
    <span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> quote, quote_plus, unquote_plus
    <span style="color:#f92672">from</span> urlparse <span style="color:#f92672">import</span> (
        parse_qs,
        parse_qsl,
        urlparse,
        unquote,
        urljoin,
        urlsplit,
        urlunparse,
    )
    <span style="color:#f92672">from</span> cgi <span style="color:#f92672">import</span> escape
    <span style="color:#f92672">import</span> HTMLParser
       
    unescape <span style="color:#f92672">=</span> HTMLParser<span style="color:#f92672">.</span>HTMLParser()<span style="color:#f92672">.</span>unescape
       
<span style="color:#66d9ef">if</span> PY3:
    <span style="color:#f92672">import</span> reprlib
    <span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> (
        parse_qs,
        parse_qsl,
        urlparse,
        quote,
        quote_plus,
        unquote,
        unquote_plus,
        urljoin,
        urlsplit,
        urlunparse,
    )
    <span style="color:#f92672">from</span> html <span style="color:#f92672">import</span> escape, unescape
    <span style="color:#f92672">from</span> queue <span style="color:#f92672">import</span> Empty, PriorityQueue
       
    unicode <span style="color:#f92672">=</span> str
</code></pre></div></li>
</ol>
</li>
<li>
<p>压力测试 / 检测反爬频率限制</p>
<ol>
<li>
<p>这个就不多提了, 不太道德, 违反了爬虫<strong>不敲打服务器</strong>的原则, 甚至会因为 dos 获罪</p>
<ol>
<li>但是如果限制参数 n=1, interval=30, 则会变为 30 秒请求一次, 可以用来做连续几天的测试, 通过日志可以发现服务器那边的反爬<strong>安全频率</strong>.</li>
<li>找出安全频率的代码还没写完, 实际上也就是从一个很大的 interval (比如60s) 开始, 每隔一段时间(比如100次请求, 或者一个小时) 将 interval 减少百分之一或者十分之一, 直到触发反爬导致请求结果失败或发生变化.</li>
</ol>
</li>
<li>
<p>这个的速度因为要做 md5 等操作, 性能打了很大折扣, 直接使用 torequests.Requests (基于 aiohttp ) 的情况下可以到 1500 qps, golang 原生可以到 6000 qps&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torequests.crawlers <span style="color:#f92672">import</span> StressTest
       
StressTest(<span style="color:#e6db74">&#39;http://localhost:8080&#39;</span>, n<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>x
<span style="color:#75715e"># [2019-10-25 20:12:01] crawlers.py(485): [17496] response: 8389296c-2, start at 2019-10-25 20:11:38 (+00:00:23), 0.131s, 754.92 req/s [100.00 %]</span>
<span style="color:#75715e"># [2019-10-25 20:12:01] crawlers.py(485): [17497] response: 8389296c-2, start at 2019-10-25 20:11:38 (+00:00:23), 0.131s, 754.96 req/s [100.00 %]</span>
<span style="color:#75715e"># [2019-10-25 20:12:01] crawlers.py(485): [17498] response: 8389296c-2, start at 2019-10-25 20:11:38 (+00:00:23), 0.132s, 754.97 req/s [100.00 %]</span>
<span style="color:#75715e"># [2019-10-25 20:12:01] crawlers.py(485): [17499] response: 8389296c-2, start at 2019-10-25 20:11:38 (+00:00:23), 0.132s, 755.02 req/s [100.00 %]</span>
<span style="color:#75715e"># [2019-10-25 20:12:01] crawlers.py(485): [17500] response: 8389296c-2, start at 2019-10-25 20:11:38 (+00:00:23), 0.131s, 755.03 req/s [100.00 %]</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>净化一个复杂的请求, 只保留最简洁的参数</p>
<ol>
<li>
<p>源代码有些脏, 就不展示了, 不是很优雅, 不过可以用</p>
</li>
<li>
<p>怕反爬就限制一下频率</p>
</li>
<li>
<p>实现原理就是得到全部 Request 参数, 然后一个个去掉, 如果去掉了某个导致 callback 结果 (默认是 md5 resp.content) 发生变化, 则该参数不是可忽略的参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torequests.crawlers <span style="color:#f92672">import</span> CleanRequest
request <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;curl &#39;https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Pragma: no-cache&#39; -H &#39;DNT: 1&#39; -H &#39;Accept-Encoding: gzip, deflate&#39; -H &#39;Accept-Language: zh-CN,zh;q=0.9&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; -H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&#39; -H &#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#39; -H &#39;Cache-Control: no-cache&#39; -H &#39;Referer: https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Cookie: ASPSESSIONIDSQRRSADB=MLHDPOPCAMBDGPFGBEEJKLAF&#39; -H &#39;Connection: keep-alive&#39; --compressed&#39;&#39;&#39;</span>
</code></pre></div></li>
</ol>
<p>c = CleanRequest(request)
print(c.x)</p>
<h1 id="url-httpsp3cn-method-get">{&lsquo;url&rsquo;: &lsquo;<a href="https://p.3.cn">https://p.3.cn</a>&rsquo;, &lsquo;method&rsquo;: &lsquo;get&rsquo;}</h1>
<pre><code> 
    

</code></pre></li>
</ol>
<h2 id="总结">总结</h2>
<p>大部分代码都是学习过程中, 遇到的一些常见问题做的练习, 活到老学到老.</p>
<p>一句话送给喜欢自学的人:</p>
<blockquote>
<p>欲修其身者，先正其心；欲正其心者，先诚其意；欲诚其意者，先致其知，致知在格物.</p>
<p>至诚之道, 可以前知.</p>
</blockquote>

                </div>
                

                


                
                
                <div style="height: 50px;"></div>
                
                

                <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="https://www.clericpy.top/newspaper/articles.query.html" target="_blank">News</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/blog/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/blog/categories/" target="_blank">Categories</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ClericPy/blog/discussions" target="_blank">Discussions</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/blog/about" target="_blank">About</a>
  </div>
  
  
</div>

            </div>
        </div>
    </article>

    <script src="/blog/js/highlight.pack.js"></script>
<script src="https://cdn.staticfile.org/quicklink/2.0.0-alpha/quicklink.umd.js"></script>

<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

    

</body>

</html>
